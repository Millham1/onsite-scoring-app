<img src="images/bbq-pig.png" style="max-width:120px;border:2px solid red;">
<img src="images/legion-medallion.png" style="max-width:120px;border:2px solid blue;">
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Whole Hog Competition 2025 â€” Landing</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root { --wh-header-h: 2.25in; --line:#dcdcdc; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; }
    header { height:var(--wh-header-h); min-height:var(--wh-header-h); position:relative; display:flex; align-items:center; justify-content:center; }
    header h1 { margin:0; line-height:1.1; text-align:center; }
    header img:first-of-type { position:absolute; left:14px; top:50%; transform:translateY(-50%); height:calc(100% - 20px); width:auto; }
    header img:last-of-type  { position:absolute; right:14px; top:50%; transform:translateY(-50%); height:calc(100% - 20px); width:auto; }
    #wholehog-nav { width:100%; margin:12px auto; display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap; text-align:center; }
    #wholehog-nav a { display:inline-block; white-space:nowrap; padding:8px 12px; border:1px solid #111; border-radius:10px; text-decoration:none; color:#111; background:#f5f5f5; }
    .container { max-width:1000px; margin:18px auto; padding:0 14px; }
    .card { border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff; }
    .card h2 { margin:0 0 10px 0; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-weight:600; }
    .input, select { padding:8px 10px; border:1px solid #bbb; border-radius:8px; }
    .btn { padding:10px 16px; border-radius:10px; border:1px solid #111; background:#f5f5f5; cursor:pointer; }
    .btn-red-black { background:#b10020; color:#111; border:2px solid #111; font-weight:700; }
    ul.clean { list-style:none; padding:0; margin:0; }
    .muted { color:#666; font-size:12px; }
    .error { color: #b10020; font-size: 13px; margin-top: 6px; }
    .success { color: #198754; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>
  <header class="header">
    <img src="Legion whole hog logo.png" alt="Logo" onerror="this.style.display='none'"/>
    <h1>Whole Hog Competition 2025</h1>
    <img src="AL Medallion.png" alt="Logo" onerror="this.style.display='none'"/>
  </header>
  <nav id="wholehog-nav">
    <a href="./onsite.html">Go to On-Site</a>
    <a href="./blind.html">Go to Blind Taste</a>
    <a href="./leaderboard.html">Go to Leaderboard</a>
    <a href="./sauce.html">Go to Sauce Tasting</a>
    <a href="./reports.html">Go to Reports</a>
  </nav>
  <div class="container">
    <!-- Teams -->
    <section class="card" id="whTeamsCard">
      <h2>Teams</h2>
      <form id="teamForm" autocomplete="off">
        <div class="row">
          <div class="field" style="flex:1 1 320px; min-width:260px;">
            <label for="whTeamName">Team Name</label>
            <input id="whTeamName" class="input" type="text" placeholder="e.g., Demo Team" required/>
          </div>
          <div style="margin-top:8px;">
            <label for="whTeamEmail" style="display:block;font-weight:600;margin-bottom:4px;">Email (optional)</label>
            <input id="whTeamEmail" type="email" inputmode="email"
                   style="width:50%;padding:8px;border:1px solid #bbb;border-radius:8px;"
                   placeholder="team@example.com" />
            <div id="whTeamEmailErr" class="error" style="display:none;">
              Please enter a valid email (e.g., name@host.com) or leave blank.
            </div>
          </div>
          <div class="field" style="flex:0 0 140px;">
            <label for="whSiteNumber">Site #</label>
            <input id="whSiteNumber" class="input" type="text" placeholder="e.g., 101"/>
          </div>
          <div class="field" style="flex:0 0 160px;">
            <label>Affiliation</label>
            <label style="display:flex; gap:8px; align-items:center;">
              <input type="checkbox" id="legionFlag"/> <span>Legion</span>
            </label>
            <label style="display:flex; gap:8px; align-items:center;">
              <input type="checkbox" id="sonsFlag"/> <span>Sons</span>
            </label>
          </div>
          <div style="flex:0 0 auto;">
            <button id="whBtnAddTeam" class="btn btn-red-black" type="submit">Add Team</button>
          </div>
        </div>
      </form>
      <div style="margin-top:14px;">
        <ul id="whTeamsList" class="clean"></ul>
      </div>
      <div id="teamStatus" class="muted"></div>
    </section>
    <!-- Judges -->
    <section class="card" id="whJudgesCard" style="margin-top:18px;">
      <h2>Judges</h2>
      <form id="judgeForm" class="row" autocomplete="off" style="gap:10px;">
        <div class="field" style="flex:1 1 320px; min-width:260px;">
          <label for="judgeName">Judge Name</label>
          <input id="judgeName" class="input" type="text" placeholder="e.g., Jamie Smith" required/>
        </div>
        <div style="flex:0 0 auto; align-self:flex-end;">
          <button class="btn" type="submit">Add Judge</button>
        </div>
      </form>
      <div style="margin-top:12px;">
        <div id="judgesList"></div>
      </div>
      <div id="judgeStatus" class="muted"></div>
    </section>
  </div>
<script>
const SUPABASE_URL = "https://hmbxboegkgwoovbtozjg.supabase.co/rest/v1";
const SUPABASE_KEY = "sb_publishable_NkwvYX4A9oasfbM2ZmEFjg_vSF9kFZt";

async function fetchTeams() {
  const response = await fetch(`${SUPABASE_URL}/teams?select=*`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
    }
  });
  return response.ok ? await response.json() : [];
}

async function fetchJudges() {
  const response = await fetch(`${SUPABASE_URL}/judges?select=*`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
    }
  });
  return response.ok ? await response.json() : [];
}

function isValidEmail(email) {
  return !email || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

async function addTeam(team) {
  const res = await fetch(`${SUPABASE_URL}/teams`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify(team)
  });
  return res.ok ? await res.json() : null;
}

async function addTeamDivision(team_name, division) {
  const res = await fetch(`${SUPABASE_URL}/team_divisions`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify({ team: team_name, division })
  });
  return res.ok ? await res.json() : null;
}

async function addJudge(judge) {
  const res = await fetch(`${SUPABASE_URL}/judges`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify(judge)
  });
  return res.ok ? await res.json() : null;
}

async function teamExists(name) {
  const teams = await fetchTeams();
  return teams.some(t => t.name && t.name.trim().toLowerCase() === name.trim().toLowerCase());
}

async function judgeExists(name) {
  const judges = await fetchJudges();
  return judges.some(j => j.name && j.name.trim().toLowerCase() === name.trim().toLowerCase());
}

async function renderTeamsList() {
  const teams = await fetchTeams();
  const ul = document.getElementById("whTeamsList");
  if (!ul) return;
  if (!teams.length) { ul.innerHTML = ""; return; }
  ul.innerHTML = teams.map(t => `<li><strong>${t.affiliation || ""}</strong> ${t.name || ""} ${t.site ? "Site #" + t.site : ""} ${t.email ? "Email: " + t.email : ""}</li>`).join("");
}

async function renderJudgesList() {
  const judges = await fetchJudges();
  const host = document.getElementById("judgesList");
  if (!host) return;
  if (!judges.length) { host.innerHTML = ""; return; }
  host.innerHTML = '<ul class="clean" style="margin:8px 0 0; padding-left:16px; list-style:disc inside;">' +
    judges.map(j => `<li>${j.name || ""}</li>`).join('') + '</ul>';
}

document.addEventListener("DOMContentLoaded", function() {
  renderTeamsList();
  renderJudgesList();

  // Team form
  document.getElementById("teamForm").addEventListener("submit", async function(ev) {
    ev.preventDefault();
    const statusEl = document.getElementById("teamStatus");
    const emailErr = document.getElementById("whTeamEmailErr");
    emailErr.style.display = "none";
    statusEl.textContent = "";

    const name = document.getElementById("whTeamName").value.trim();
    const email = document.getElementById("whTeamEmail").value.trim();
    const site = document.getElementById("whSiteNumber").value.trim();
    const legion = document.getElementById("legionFlag").checked;
    const sons = document.getElementById("sonsFlag").checked;
    let affiliation = "";
    if (legion) affiliation += "Legion";
    if (sons) affiliation += (affiliation ? " & " : "") + "Sons";

    if (!name) { statusEl.textContent = "Enter a team name."; statusEl.className = "error"; return; }
    if (!isValidEmail(email)) { emailErr.style.display = "block"; return; }

    // Check for duplicate
    if (await teamExists(name)) {
      statusEl.textContent = "Team already exists."; statusEl.className = "error"; return;
    }

    // Save team
    const teamObj = {
      name,
      email: email || null,
      site: site || null,
      affiliation
    };
    const added = await addTeam(teamObj);
    if (added && added[0]) {
      // Save team_division if flagged
      if (legion) await addTeamDivision(name, "Legion");
      if (sons) await addTeamDivision(name, "Sons");
      statusEl.textContent = "Saved in Supabase!"; statusEl.className = "success";
      renderTeamsList();
      document.getElementById("teamForm").reset();
    } else {
      statusEl.textContent = "Error saving team."; statusEl.className = "error";
    }
  });

  // Judge form
  document.getElementById("judgeForm").addEventListener("submit", async function(ev) {
    ev.preventDefault();
    const statusEl = document.getElementById("judgeStatus");
    statusEl.textContent = "";

    const name = document.getElementById("judgeName").value.trim();
    if (!name) { statusEl.textContent = "Enter a judge name."; statusEl.className = "error"; return; }
    if (await judgeExists(name)) {
      statusEl.textContent = "Judge already exists."; statusEl.className = "error"; return;
    }

    const judgeObj = { name };
    const added = await addJudge(judgeObj);
    if (added && added[0]) {
      statusEl.textContent = "Saved in Supabase!"; statusEl.className = "success";
      renderJudgesList();
      document.getElementById("judgeForm").reset();
    } else {
      statusEl.textContent = "Error saving judge."; statusEl.className = "error";
    }
  });
});
</script>
</body>
</html>
